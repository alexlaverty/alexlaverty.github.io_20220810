function removeSelection(e){"use strict";var t,a;e&&(t=document.createRange(),t.selectNodeContents(e)),a=window.getSelection?window.getSelection():document.selection?document.selection:null,null!==a&&(a.empty?a.empty():a.removeAllRanges()),e&&a.addRange(t)}function savePersonLifestoryNarrative(){"use strict";var e=$(".lifeStoryNarrative"),t=$("#narrativeText"),a=t.data("narrative-original"),n=$(".lifeStoryNarrative .closeNarEditingSave:visible");""!==t.text&&t.html(t.html().replace(/(\n)/g,"<br>"));var r=convertHTML(t.html());a===r?$(".closeNarEditingCancel:visible").trigger("click"):e.hasClass("lifeStoryNarrativeEditing")&&n.addClass("loading").data("save",n.html()).html(n.data("saving"));var i=getPersonAjaxUrlPrefix()+"/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/savepersonlifestorynarrative";$.ajax({type:"POST",url:i,cache:!1,timeout:2e4,data:{narrative:r},success:function(e){e.result?null!==e.eventNarrative&&(r.length>0?(t.data("narrative-original",r),$(".closeNarEditingCancel:visible").trigger("click"),n.removeClass("loading").html(n.data("save"))):0===r.length?window.location.reload():r!==a&&window.glue.reload(window.glue.reloaded)):null!==acom&&null!==acom.bus&&void 0!==window.PersonStory&&(n.removeClass("loading").html(n.data("save")),acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0))},error:function(){n.removeClass("loading").html(n.data("save")),null!==acom&&null!==acom.bus&&void 0!==window.PersonStory&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)}})}$(function(){"use strict";var e=navigator.userAgent.indexOf("Safari")>-1,t=!1,a=!1,n=$("#narrativeText"),r=$(".lifeStoryNarrative");e&&n.css("display","block"),r.off().on("click",".editButton",function(){n.data("narrative-original",convertHTML(n.html())),closeCallouts(),$(".timelineItem").addClass("timelineItemEditingDisabled"),r.addClass("lifeStoryNarrativeEditing").find(".con").addClass("bgDark bgColor1").end().find(".narrativeText").addClass("con"),n.attr({contenteditable:"true",spellcheck:"false"}).focus()}).on("click",".closeNarEditingCancel",function(){removeSelection(),n.removeAttr("contenteditable spellcheck"),$(".timelineItem").removeClass("timelineItemEditingDisabled"),r.removeClass("lifeStoryNarrativeEditing").find(".narrativeText").removeClass("con").end().find(".bgDark").removeClass("bgDark bgColor1").focus(),n.html(convertText(n.data("narrative-original")))}).on("click",".addLifeStory",function(){$(this).closest(".lifeStoryNarrative").find(".editButton").trigger("click")}).on("mousedown",".narrativeText",function(){t=!1,a=!1}).on("focus",".narrativeText",function(){t||a?removeSelection(this):(t=!1,a=!1)}).on("keydown",".narrativeText, .closeNarEditing",function(e){t=!1,a=!1,9===e.which&&e.shiftKey&&(a=!0),9!==e.which||e.shiftKey||(t=!0)}).on("keyup",".narrativeText",function(){var e=$(this);""===e.text()&&e.empty()}).on("blur",".narrativeText",function(e){return e.preventDefault(),removeSelection(),window.personScreenType("smart-phone")&&a&&r.find(".closeNarEditingCancel:visible").focus(),!window.personScreenType("smart-phone")&&t&&r.find(".closeNarEditingCancel:visible").focus(),!window.personScreenType("smart-phone")&&a&&r.find(".closeNarEditingSave").focus(),!1}).on("paste",".narrativeText",function(e){e.preventDefault();var t="";e.clipboardData||e.originalEvent.clipboardData?t=e.originalEvent.clipboardData.getData("text/plain")||e.clipboardData.getData("text/plain"):window.clipboardData&&(t=window.clipboardData.getData("Text")),document.queryCommandSupported("insertHTML")?(t=convertHTML(t.trim()),document.execCommand("insertHTML",!1,t)):document.queryCommandSupported("insertText")?document.execCommand("insertText",!1,t):document.execCommand("paste",!1,t)}).on("blur",".closeNarEditingCancel",function(){return window.personScreenType("smart-phone")&&t?(r.find(".narrativeText").focus(),!1):!window.personScreenType("smart-phone")&&a?(r.find(".narrativeText").focus(),!1):void 0})});
//# sourceMappingURL=life-story-narrative-dded5a08.min.js.map